<!doctype html>
<html lang="en">
<head>
<title>Trade Data Visualisation Developer Guide</title>
<!-- 2018-02-07 Wed 09:13 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Louis Tsiattalou">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<style>body { margin-bottom: 0px; }</style><script type="text/javascript">
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  displayAlign: "center",
  displayIndent: "2em",
  messageStyle: "none",
  "HTML-CSS": {
    scale: 100,
    styles: {
      ".MathJax_Display": {
        "font-size": "100%"
      }
    }
  },
  "SVG": {
    scale: 100,
    styles: {
      ".MathJax_SVG_Display": {
        "font-size": "100%",
        "margin-left": "-2.281em"
      }
    }
  }
});
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_SVG"></script>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">Trade Data Visualisation Developer Guide</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Contents</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Introduction
</li>
<li>Live R Scripts
</li>
<li>Shiny Application
</li>
<li>Complexities
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Introduction</h2>
<div class="outline-text-2" id="text-2">
<p>
Welcome to my Trade Data Visualisation project. This project is an online tool developed in R, with a frontend in Shiny. It talks to a PostgreSQL database hosted on AWS. Its purpose is to simplify the act of working with UK Trade Data; which is archived at <a href="https://uktradeinfo.com">UKTradeInfo</a> in nested Zip files.
</p>

<p>
The data itself isn't very descriptive. You have to cross reference a bunch of different explanatory documents to understand the format of the data, what each column represents, Country/Port/Commodity codes, etc. This application does all of this for the user by doing all the necessary data work on a PostgreSQL database, which is maintained fully by (and can be recreated completely from) the Live R Scripts in this repository.
</p>

<p>
A similar tool existed in the past, but was not robust and not entirely suited to the FSA's needs; it broke in 2016 and was never repaired henceforth. This application was designed from the ground up to the FSA's specific stakeholder requirements and is far more robust. This readme is to serve as the administration guide for the application, so it can be maintained by anyone, not just myself.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Live R Scripts</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Data Cleaning and Setup</h3>
<div class="outline-text-3" id="text-3-1">
</div><div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> <code>DownloadData.R</code></h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
This R Script automatically connects to <a href="https://uktradeinfo.com/">UKTradeInfo</a>, and downloads the archives for a set number of years of the following files:
</p>
<ul class="org-ul">
<li>SMKA12 // Commodity Codes and their Descriptions
</li>
<li>SMKI19 // Imports from Non-EU Sources
</li>
<li>SMKE19 // Exports to Non-EU Destinations
</li>
<li>SMKM46 // Imports from EU Sources
</li>
<li>SMKX46 // Exports to EU Destinations
</li>
</ul>
<p>
More information on these files, as well as their column names and formats, can be found in the <a href="https://github.com/fsa-analytics/TradeDataVis/tree/master/File%2520Glossary%2520and%2520Specifications">File Glossary and Specifications</a> section of the repository.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Loading Data to the Database</h3>
<div class="outline-text-3" id="text-3-2">
<p>
<i>Note: A PostgreSQL Database must be set up either locally or remotely for these scripts to work. Their parameters must be saved in the <code>.env</code> file in the order denoted by the <code>.env.example</code> files in the repository.</i>
</p>
</div>

<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> <code>InitialiseDataTables.R</code></h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
This script takes the unzipped <code>SMK*</code> files and loads them into a PostgreSQL database defined in the user-specified <code>.env</code> file, to be found in the root directory of the repository. Four tables are created (or destroyed and recreated if they already exist):
</p>

<ul class="org-ul">
<li><code>imports</code>
</li>
<li><code>exports</code>
</li>
<li><code>arrivals</code>
</li>
<li><code>dispatches</code>
</li>
<li><code>control</code>
</li>
</ul>

<p>
There's a lot more processing that goes on for the control table; this is because SMKA12 files (control) are far more dirty and require lots of string manipulation (to homogenise quotes, pad commodity codes to appropriate lengths, deal with heterogeneous column specs over time, etc.) It also requires <code>UPSERT</code> functionality. More detail on this can be found in the <b>Complexities/Commodity Codes</b> section below.
</p>

<p>
Lastly, it defines indices for the <code>imports</code>, <code>exports</code>, <code>arrivals</code> and <code>dispatches</code> tables. This means that, when queried by the application, query times go from \(>1\) minute to \(~2-10\) seconds.
</p>
</div>
</div>

<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> <code>InitialiseMetadataTables.R</code></h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
This script creates the following tables:
</p>

<ul class="org-ul">
<li><code>comcode</code>
</li>
<li><code>country</code>
</li>
<li><code>port</code>
</li>
</ul>

<p>
These tables are used for lookup tables, replacing codes with descriptions in visualisations and selectors, etc.
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-2-2-1" name="sec-3-2-2-1"></a><code>comcode</code> table<br ><div class="outline-text-5" id="text-3-2-2-1">
<p>
Since HMRC's <code>SMKA12</code> control file (which contains 8-digit commodity codes [with a trailing 0 for some unknown reason]) doesn't contain 6/4/2 digit commodity codes, there's no way to know the structure of the commodity codes. You can't build a hierarchy from just 8-digit codes without any parent information! Thankfully, we can obtain a structure from <a href="http://ec.europa.eu/eurostat/">Eurostat</a>. They update a full list of commodity codes every year. While they won't have legacy codes that we need for past data, it allows us to build a structure by following this rule:
</p>

<blockquote>
<p>
All codes of the form <code>wwxxyyzz</code> will be children of either <code>ww</code>, <code>wwxx</code>, or <code>wwxxyy</code>.
</p>
</blockquote>

<p>
Simple, right? So everything under <code>0101xxyy</code> must be descendants of <code>0101</code>. So this code basically:
</p>

<ol class="org-ol">
<li>Copies the <code>control</code> table.
</li>
<li>Adds a <i>parent</i> column by stripping the last two characters off a commodity code, and checking whether it exists. If not, it strips off another two characters, and so on until a parent is found.
</li>
<li>Joins descriptions onto the end of the table.
</li>
</ol>

<p>
This results in a simple table with <i>comcode</i>, <i>parent</i>, and <i>description</i> fields, which can be completely imported into the application for multiple purposes.
</p>
</div>
</li>

<li><a id="sec-3-2-2-2" name="sec-3-2-2-2"></a><code>port</code> table<br ><div class="outline-text-5" id="text-3-2-2-2">
<p>
Again, a data file for this section (latitude and longitude information for different port codes) needs to be downloaded automatically from <a href="http://www.unece.org/cefact/codesfortrade/codes_index.html">UN/LOCODE</a> and renamed to LatLonPorts.zip. For both this and the Eurostat <code>comcode</code> data file, the URL changes very regularly. So you can either download manually when you run the script, or you can uncomment the automatic download utilities in the script and replace the URL with the updated one. The choice is yours.
</p>

<p>
The list of Ports (Air and Sea) is downloaded automatically from <a href="https://uktradeinfo.com/">UKTradeInfo</a> and cleaned, to get fields <i>portcode</i>, <i>portname</i>, and <i>type</i> (either Airport or Seaport). Then the UN/Locode lat/lon file is unzipped, merged with <code>missingports.csv</code> (found in the root of the repository, manually compiled since UN/LOCODE was missing some ports), and joined onto the dataframe built from UKTradeInfo data. This gives a final table with <i>portcode</i>, <i>portname</i>, <i>type</i>, <i>lat</i>, <i>long</i>. At the time of writing, <i>lat</i> and <i>long</i> are not used, since UN/LOCODE only has lat/lon coordinates going down to 2 or 3 d.p! This is quite inaccurate when mapped at the UK level (but fine for the worldwide level), so many ports look very wrong. Work in Progress&#x2026;!
</p>

<p>
Note that there is some logic to strip out minor ports. When the port file is imported into R, you may notice that portcodes are not unique! This is obviously unacceptable. Although, upon close inspection, you will notice that there is always one capitalised port for duplicated portcodes. This is the "main port" for that code. We strip away the minor, non-capitalised ports, since they are inconsequential and can lead to misleading results in the visualisations. Doing this provides us a primary key on portcodes, which can be used for matching.
</p>
</div>
</li>

<li><a id="sec-3-2-2-3" name="sec-3-2-2-3"></a><code>country</code> table<br ><div class="outline-text-5" id="text-3-2-2-3">
<p>
This one's easy. UKTradeInfo has a list of country codes available with a very static URL. It's downloaded, cleaned, and entered into the <code>country</code> table. Then we have a lookup table for countries, the same as we have for ports and comcodes, that can be imported into the application <i>as-is</i> so it can be used for lookups.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> Other Scripts</h4>
<div class="outline-text-4" id="text-3-2-3">
</div><ol class="org-ol"><li><a id="sec-3-2-3-1" name="sec-3-2-3-1"></a><code>MonthlyUpdate.R</code><br ><div class="outline-text-5" id="text-3-2-3-1">
<p>
This is a modified <code>InitialiseDataTables.R</code>, with some additional bells and whistles. By modifying the <code>syr</code> and <code>smth</code> variables, you can load a single month of data into the database. Before loading anything, it checks if there's more than 50 records with that month, to stop double-loading into the database.
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-2-3-1-1" name="sec-3-2-3-1-1"></a><span class="label label-primary TODO">TODO</span> I plan on creating a UI for this using Shiny.<br ></li></ol>
</li>

<li><a id="sec-3-2-3-2" name="sec-3-2-3-2"></a><code>QueryTemplate.R</code><br ><div class="outline-text-5" id="text-3-2-3-2">
<p>
This is essentially a scratch script providing a way to query data from either a local/remote copy of the trade data database to play around with in the console. You may need to make some changes to it, as with the other scripts, to get it working with your setup. 
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Shiny Application Script <code>app.R</code></h3>
<div class="outline-text-3" id="text-3-3">
<p>
You can find this in the <i>Shiny</i> folder in the root of the repository. This contains its own <code>.env</code> file, which is published with <code>app.R</code> to <a href="https://shinyapps.io/">shinyapps.io</a> from the RStudio Publish function.
</p>

<blockquote>
<p>
<b>WARNING</b>
</p>

<p>
<b>You will struggle to understand how the application works if you do not have a basic working knowledge of Shiny applications. Concepts like reactivity are difficult to get your head around at first. The <code>app.R</code> script is very long, and not executed in a linear fashion by the Shiny server. Make sure that you have a working knowledge of Shiny and reactivity first. I recommend starting <a href="https://shiny.rstudio.com/tutorial/">with this video tutorial</a>, making a couple of basic apps using online templates, <i>then</i> taking a look at <code>app.R</code>.</b>
</p>
</blockquote>
</div>

<div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> Packages</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Below is a list of all the packages used by the application.
</p>

<ul class="org-ul">
<li><code>shiny</code>
</li>
<li><code>shinyjs</code>
</li>
<li><code>shinyWidgets</code>
</li>
<li><code>shinycssloaders</code>
</li>
<li><code>shinythemes</code>
</li>
<li><code>tidyverse</code>
</li>
<li><code>devtools</code>
</li>
<li>~Development Versions of:
<ul class="org-ul">
<li><code>ggplot2</code>
</li>
<li><code>pool</code>
</li>
</ul>
</li>
<li><code>RPostgreSQL</code>
</li>
<li><code>networkD3</code>
</li>
<li><code>rgeos</code>
</li>
<li><code>maptools</code>
</li>
<li><code>maps</code>
</li>
<li><code>DT</code>
</li>
<li><code>leaflet</code>
</li>
<li><code>plotly</code>
</li>
<li><code>scales</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-3-2" class="outline-4">
<h4 id="sec-3-3-2"><span class="section-number-4">3.3.2</span> Functions</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
Below is a list of custom functions used in the application, and how they work.
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-3-2-1" name="sec-3-3-2-1"></a><code>descendants(data,code)</code><br ><div class="outline-text-5" id="text-3-3-2-1">
<ul class="org-ul">
<li>Arguments:
<ul class="org-ul">
<li><code>data</code>: Data Frame with columns <i>commoditycode</i> and <i>parent</i>. Used to look up descendants.
</li>
<li><code>code</code>: Character vector containing commodity codes to find the descendants of.
</li>
</ul>
</li>
</ul>

<p>
This function implements a recursive algorithm to obtain all the descendants of a vector of commodity codes. It finds all the children of the codes in the <i>code</i> vector. If these are all 8-digit codes, great! The function exits. If they aren't, then there must be more children, since 2/4/6-digit codes must have children.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-3-3-3" class="outline-4">
<h4 id="sec-3-3-3"><span class="section-number-4">3.3.3</span> Database Connection</h4>
<div class="outline-text-4" id="text-3-3-3">
<p>
The shiny app needs to connect to the database in a way such that it supports multiple users. In order to do this, I'm using a package called <code>pool</code>. It opens up a certain amount of database connections (in our case, 3) and opens more if more connections are required by people using the application. Using an elastic database connection system like this means that parallel queries are possible for when many people are using the app at once. It has a maximum database connection limit of 40; this is effectively a hard limit on the number of concurrent users who can use the app at once. This can be raised to 100 without making changes to the underlying Postgres database.
</p>
</div>
</div>

<div id="outline-container-sec-3-3-4" class="outline-4">
<h4 id="sec-3-3-4"><span class="section-number-4">3.3.4</span> Preamble</h4>
<div class="outline-text-4" id="text-3-3-4">
<p>
There is some code in <code>app.R</code> prior to the "meat" of the Shiny App, the UI and Server functions. This is mainly used for setup functions and loading in lookup tables from Postgres. In order, here are the tasks performed:
</p>
<ul class="org-ul">
<li>Load <code>port</code>, <code>country</code>, <code>comcode</code> tables into R and clean them up by removing duplicates.
</li>
<li>Generate secondary lookup dataframes:
<ul class="org-ul">
<li><code>comcodelookup</code>: same as comcode, but with the <i>commoditycode</i> field as a factor. Used to allow multiple comcode searches in the comcode lookup tab.
</li>
<li><code>desclookup</code>: a combination of <code>portcode</code> and <code>countrycode</code> dataframes for replacing port/countrycodes with descriptions in selectors and visualisations.
</li>
<li><code>comcode_x</code>: Replace x with 2/4/6/8. Subsets of the <code>comcode</code> dataframe by commodity code length. Used for the 2/4/6/8-digit commodity code selectors in the UI.
</li>
</ul>
</li>
<li>Creating the <code>dates</code> list; in a universal format (YYYY-MM), in reverse order, including the 2.5 month time lag on trade data becoming available.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-3-5" class="outline-4">
<h4 id="sec-3-3-5"><span class="section-number-4">3.3.5</span> <code>ui()</code></h4>
<div class="outline-text-4" id="text-3-3-5">
<p>
There are five sections to the <code>ui</code> function. It uses a <code>navbarPage</code> setup; which is essentially multiple fluidpages found under different tabs. So; five tabs are accessible and each is defined with a big <code># &lt;NAME&gt; PAGE</code> title to separate them easily.
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-3-5-1" name="sec-3-3-5-1"></a>Welcome Page<br ><div class="outline-text-5" id="text-3-3-5-1">
<p>
This is a bit of a dump of shiny-fied HTML with no interactive elements. In shiny, HTML tags are implemented as methods of the <code>tags</code> object. So HTML: <code>&lt;b&gt;text&lt;/b&gt;</code> is implemented with the syntax in R: <code>tags$b("text")</code>. This acts as the user guide for the application, so make sure it is regularly updated and descriptive.
</p>
</div>
</li>

<li><a id="sec-3-3-5-2" name="sec-3-3-5-2"></a>Commodity Code Lookup<br ><div class="outline-text-5" id="text-3-3-5-2">
<p>
A very simple tab that fulfills a very important function. It simply contains a DataTable (from package <code>DT</code>) for looking up commodity codes using search bars. Its properties are defined in the <code>server</code> function.
</p>
</div>
</li>

<li><a id="sec-3-3-5-3" name="sec-3-3-5-3"></a>Non-EU Trade<br ><div class="outline-text-5" id="text-3-3-5-3">
<p>
This will be very similar in layout to EU Trade. In the <code>head</code> section of the HTML, a custom theme for the progress bar is defined. The rest of the code in this section is mostly organised into fluidrows so I can organise the UI Elements like <code>selectizeInput</code> boxes into neat columns.
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-3-5-3-1" name="sec-3-3-5-3-1"></a>Query Pane<br ><div class="outline-text-6" id="text-3-3-5-3-1">
<p>
From left to right, this pane contains:
</p>
<ul class="org-ul">
<li>Date Start and End selectors, with options defined in the preamble (<code>dates</code> vector)
</li>
<li>Country and Port selectors, containing the <i>countryname</i> and <i>portname</i> fields of the countrycode/portcode lookup dataframes loaded in the preamble.
</li>
<li>Comcode Selectors (2/4/6/8 digits). These use the <code>descendants</code> function defined in the preamble to repopulate all the descendant selectors with its children. So, selecting 01 in the 2-digit selector will populate the 4/6/8-digit selectors with its descendants.
</li>
<li>Radio Buttons to choose between Imports/Exports and the button to execute the query.
</li>
</ul>
</div>
</li>

<li><a id="sec-3-3-5-3-2" name="sec-3-3-5-3-2"></a>Comcode Legend<br ><div class="outline-text-6" id="text-3-3-5-3-2">
<p>
This is a simple DataTable populated with all the 8-digit commodity codes found within the current query, along with their descriptions. It acts as a quick-reference table so you don't have to switch tabs to the Comcode Lookup page and search for the relevant codes.
</p>
</div>
</li>

<li><a id="sec-3-3-5-3-3" name="sec-3-3-5-3-3"></a>Filter Pane<br ><div class="outline-text-6" id="text-3-3-5-3-3">
<p>
This fluidrow contains controls for filtering the results of the query made in the <b>Query Pane</b>. It contains:
</p>
<ul class="org-ul">
<li>All tickbox: This tickbox controls whether the visualisations show all the data in the query, or single months.
</li>
<li>Date Slider: This becomes active if the All tickbox is unticked (disabled by default). It is a slider which allows the user of the application to select individual months in the query's date range. Sliding across the Date Slider allows you to see the evolution in time of the trade data.
</li>
<li>Unit Selector: A radio button selector which allows you to change the Units represented in the visualisations. For Non-EU Trade, you can select between <i>Price</i> (£), <i>Weight</i> (KG), and <i>Price per Kilo</i> (£/KG).
</li>
</ul>
</div>
</li>

<li><a id="sec-3-3-5-3-4" name="sec-3-3-5-3-4"></a>Visualisation Pane<br ><div class="outline-text-6" id="text-3-3-5-3-4">
<p>
The real star of the show. A tabsetPanel allowing you to switch between:
</p>
<ul class="org-ul">
<li>Sankey Diagram: for viewing the flow from country &gt; commodity &gt; port. Implemented with the <code>networkD3</code> package.
</li>
<li>World Map: for viewing the distribution of imports/exports on an interactive world map. Implemented with the <code>Leaflet</code> package.
</li>
<li>Time Series: Stacked bar charts by Country, Commodity and Port. Allows you to view the proportion of trade between different countries/commodities/ports. Implemented with the <code>Plotly</code> and <code>ggplot2</code> packages.
</li>
</ul>

<p>
All of these visualisations are interactive, allowing the user to obtain more information by hovering, clicking, etc. They are mostly wrappers for Javascript libraries, implemented in R for Shiny Applications.
</p>
</div>
</li>

<li><a id="sec-3-3-5-3-5" name="sec-3-3-5-3-5"></a>Download Button<br ><div class="outline-text-6" id="text-3-3-5-3-5">
<p>
Simple as that. Allows the user to download the full set of data queried in the <b>Query Pane</b>.
</p>
</div>
</li></ol>
</li></ol>
</div>



<div id="outline-container-sec-3-3-6" class="outline-4">
<h4 id="sec-3-3-6"><span class="section-number-4">3.3.6</span> <code>server()</code></h4>
<div class="outline-text-4" id="text-3-3-6">
<p>
The server function is the engine behind the application - what drives all the visualisations, selectors, etc. This section will go through and explain the different sections of the code, as defined by the capitalised headers for each section.
</p>

<p>
The application first defines all reactive values necessary for the application. When the queries are run, these reactive values are populated with raw and processed data (in formats relevant for each visualisation; Sankey/Map/TimeSeries).
</p>
</div>

<ol class="org-ol"><li><a id="sec-3-3-6-1" name="sec-3-3-6-1"></a>Server Side Commodity Code Lookup<br ><div class="outline-text-5" id="text-3-3-6-1">
<p>
This section contains the code necessary for rendering the DataTable (which is essentially a bunch of arguments for the different options offered by the <code>DT</code> package for the <code>renderDataTable()</code> function).
</p>
</div>
</li>

<li><a id="sec-3-3-6-2" name="sec-3-3-6-2"></a>ShinyJS OnClick Statements<br ><div class="outline-text-5" id="text-3-3-6-2">
<p>
We use the <code>shinyjs</code> package for some fine tuned javascript settings. This section contains code to:
</p>
<ul class="org-ul">
<li>Blank out the commodity code selectors when clicked (Non-EU and EU)
</li>
<li>Disable/Enable the Date Slider according to whether the All tickbox is Enabled/Disabled (respectively)
</li>
</ul>
</div>
</li>

<li><a id="sec-3-3-6-3" name="sec-3-3-6-3"></a>Observe Statements for Modifying Dropdowns<br ><div class="outline-text-5" id="text-3-3-6-3">
<p>
When the commodity code selectors are changed, then all of the descendant levels need to be updated to show only descendants of those commodity codes. By default, the selectors show all valid commodity codes to begin with. Then, when the 2-digit selector is changed to, say, <code>01</code>, then the 4-digit, 6-digit and 8-digit selectors need to be updated to show <i>only the descendants of commodity code <code>01</code></i>.
</p>

<p>
So, using <code>observe()</code> functions, which fire the code contained within them whenever a reactive object in that code block is changed, we are able to make the selectors update with descendants whenever they're changed, and only when they're changed. 
</p>

<p>
There is also an <code>All</code> option in the selectors; this is used when you don't want to specify the detail all the way down to 8-digit level. You may be interested in <i>All Live Horse Imports</i>. You would then select <code>01</code> in the 2-digit selector, <code>0101</code> in the 4-digit selector, and leave the 6 and 8-digit selectors on "All". This allows the user to make wider ranging queries easily, rather than having to hunt down all horse-related 8-digit commodity codes.
</p>
</div>
</li>
<li><a id="sec-3-3-6-4" name="sec-3-3-6-4"></a>Execute Query<br ><div class="outline-text-5" id="text-3-3-6-4">
<p>
This code runs when the <i>Run Query</i> button is pressed. The code in this section is wrapped in an <code>observeEvent()</code> function, which runs the code if and only if the reactive object specified in the first argument (so <code>input$queryButton</code>, for us) is activated or changed in some way. Since it's a button in our case, it reacts every time it is pressed and executes the code.
</p>

<p>
The point of this block of code is to essentially take the input information from the Query Pane, construct a valid SQL query from this, and query the PostgreSQL table that holds all the trade data to get the data in an R Dataframe for analysis and visualisation.
</p>

<p>
The following list is the tasks executed and how they work.
</p>

<ul class="org-ul">
<li>Pop a progress bar onto the screen.
</li>
<li>Ensure the <code>nullDataframe</code> reactive object is set to FALSE for error handling.
</li>
<li>Construct the commodity codes to be queried
<ul class="org-ul">
<li>If the selector was set to "All" or left blank, sub in two underscores <code>__</code>. This is a wildcard character in PostgreSQL's regular expression engine, which we use to filter on commodity codes.
</li>
<li>Once the four vectors of commodity codes are constructed, paste them together to get a vector of (maximum) 20-character strings. Take the final 8 characters from these strings to obtain the commodity codes to query.
</li>
<li>This is a very weird way of doing things; ordinarily one would use if/elseif/else logic to determine what the lowest level of detail selected in the query pane was, and append trailing underscores to get all 8-digit commodity codes that descend from it. But, this is less computationally intensive, and elegant in it's own stupid way&#x2026;!
</li>
</ul>
</li>
<li>Create a list of Ports and Countries to be queried, either by taking the full list defined in the <code>portcode</code> and <code>countrycode</code> dataframes, or filter by those chosen in the Port and Country selectors.
</li>
<li>Modify the DateSlider with values between the Date Start and Date End selectors
</li>
<li>Convert the <code>daterangequery</code> vector to the format used in the <code>import</code> and <code>export</code> tables.
</li>
<li>Construct the query and store it in the <code>dataquery</code> character string. It is heavily parametrized due to the number of options that need to be added in.
<ul class="org-ul">
<li>Define the parts of the query that are dependent on whether the user wants Imports or Exports. This affects:
<ul class="org-ul">
<li>The ordering of fields in the <code>SELECT</code> statement.
</li>
<li>The field selected in the <code>country</code> section of the <code>WHERE</code> statement. For Imports, you want <i>Country of Origin</i>. For Exports, you want <i>Country of Dispatch</i>.
</li>
<li>The ordering of fields in the <code>GROUP BY</code> statement.
</li>
</ul>
</li>
<li>Paste together the various components of the query to get a single string.
<ul class="org-ul">
<li>Note that this string will be <i>extremely</i> long. The string constructed will have a very large number of commodity codes, ports and countries in it. This is because the <code>comcodequery</code>, <code>countryquery</code>, <code>portquery</code> and <code>daterangequery</code> vectors will likely contain a large number of elements, which are collapsed into a format recognisable to PostgreSQL's Regular Expression (<code>regex</code>) engine. This is of the form <code>(&lt;item1&gt;|&lt;item2&gt;|...|&lt;itemN&gt;)</code>, where the pipe <code>|</code> is a logical <code>OR</code> operator.
</li>
</ul>
</li>
</ul>
</li>
<li>Execute the query and store the result in the <code>dataraw</code> dataframe.
</li>
<li>Check if the query returned data:
<ul class="org-ul">
<li>If not, set the <code>nullDataframe</code> flag to <code>TRUE</code>, and display a modalDialog with an error message. Then break out of the reactive chain with <code>req(FALSE)</code>.
</li>
</ul>
</li>
<li>Simplify the column names of <code>dataraw</code>.
</li>
<li>Split <code>dataraw</code> into two dataframes:
<ul class="org-ul">
<li><code>portsumraw</code>: Eliminate the <i>port</i> field, group by <i>country</i> and <i>comcode</i>, and aggregate numeric values.
</li>
<li><code>countrysumraw</code>: Eliminate the <i>country</i> field, group by <i>comcode</i> and <i>port</i>, and aggregate numeric values.
</li>
</ul>
</li>
<li>Translate the months in <code>portsumraw</code> and <code>countrysumraw</code> back into the <code>YYYY-MM</code> format used elsewhere in the application.
</li>
<li>Handle missing values in <code>portsumraw</code> and <code>countrysumraw</code> by replacing with "Unknown Country/Port".
</li>
<li>Store <code>dataraw</code>, <code>portsumraw</code>, and <code>countrysumraw</code> in the <code>queryData</code> reactive variable defined at the beginning of the <code>server</code> section.
</li>
</ul>
</div>
</li></ol>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Complexities</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Commodity Codes</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Commodity Codes Control Files (SMKA_) contain some serious complexities. They are listed below in bulletted form. 
</p>
<ul class="org-ul">
<li>Commodity Codes are obviously primary keys - you can't have the same commodity code contain completely different types of data! The way this is handled is that the commodity code is <span class="underline">added</span> if it does not exist within the table. If it <span class="underline">already exists</span>, that entry is updated with the information in the current SMKA file. This method of adding/updating is referred to as <code>UPSERT</code> (portmanteau of update-insert). This has to be done using line-by-line SQL queries, as R's <code>DBI</code> package does not support UPSERT operations. As we consider SMKA files sequentially from 200901, we always have the most up-to-date description for each commodity code.
</li>
<li>SMKA files prior to 201201 have the SUB unicode character in one of the commodity code descriptions. All data analysis tools use this character as the EOF marker - stopping the dataload! This is an outstanding issue.
</li>
<li>Older pre-2012 SMKA files also split the description up with a | delimiter after it reaches a certain character limit for god knows what reason. SQL table limits pre-2012 maybe? I don't know. I do know that it's annoying to deal with. There's some lines which merge the final two columns in the data frame if they exceed the number of columns in the new data format to homogenise the data structures so everything can be loaded into the same table.
</li>
<li>Lastly, since the descriptions contain both " and ' chars, quoting is set to null for the <code>read.table</code> load. Apostrophes are all converted to double apostrophes <code>''</code> during the data cleaning routine, as SQL statements rely on the <code>'</code> char for denoting strings!
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Shiny Application</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> Price per KG</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
It should be noted here that it's impossible to have the same number matching up on either side of the commodity code node on the Sankey Diagram and still have detail from both sides. Price per KG is a relative quantity, not an absolute one. Sankey diagrams are meant to show the flow of an absolute quantity, not a collection of ratios. The map is still valuable in this case. For H1-2009, we can see that Brazil's GBP/KG value is higher than the UAE, despite the magnitude of UAE's total exports to us dwarfing that of Brazil.
</p>
</div>
</div>
</div>
</div>
</div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Contents</a></li>
<li><a href="#sec-2">2. Introduction</a></li>
<li><a href="#sec-3">3. Live R Scripts</a>
<ul class="nav">
<li><a href="#sec-3-1">3.1. Data Cleaning and Setup</a>
<ul class="nav">
<li><a href="#sec-3-1-1">3.1.1. <code>DownloadData.R</code></a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. Loading Data to the Database</a>
<ul class="nav">
<li><a href="#sec-3-2-1">3.2.1. <code>InitialiseDataTables.R</code></a></li>
<li><a href="#sec-3-2-2">3.2.2. <code>InitialiseMetadataTables.R</code></a></li>
<li><a href="#sec-3-2-3">3.2.3. Other Scripts</a></li>
</ul>
</li>
<li><a href="#sec-3-3">3.3. Shiny Application Script <code>app.R</code></a>
<ul class="nav">
<li><a href="#sec-3-3-1">3.3.1. Packages</a></li>
<li><a href="#sec-3-3-2">3.3.2. Functions</a></li>
<li><a href="#sec-3-3-3">3.3.3. Database Connection</a></li>
<li><a href="#sec-3-3-4">3.3.4. Preamble</a></li>
<li><a href="#sec-3-3-5">3.3.5. <code>ui()</code></a></li>
<li><a href="#sec-3-3-6">3.3.6. <code>server()</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. Complexities</a>
<ul class="nav">
<li><a href="#sec-4-1">4.1. Commodity Codes</a></li>
<li><a href="#sec-4-2">4.2. Shiny Application</a>
<ul class="nav">
<li><a href="#sec-4-2-1">4.2.1. Price per KG</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
</div></div></div>
</body>
</html>
